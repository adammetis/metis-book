---
sidebar_position: 2
---

# Schema Migration Analysis

### TL;DR

Metis can scan your pull requests for changes in your database schema, analyze those changes and show you insights about them.

[https://youtu.be/-ZwQGF5L3xQ](https://youtu.be/-ZwQGF5L3xQ)

**General:**

In some cases, adding new features to the application require changes in the schema of the database too. Changing the schema of the DB is also called "**Schema Migration**".

Changing the schema might cause one of the following problems:

- Data Loss
- Application Errors
- Performance problems
- Data Quality
- Security risks

**How it works:**

The SQL commands used for changing the schema of the databases are usually stored in a folder. ~~If you are using an ORM then it manages the SQL commands in a folder, usually with a subfolder for each version.~~

The GitHub Action review all the migration SQL commands and sends them to Metis, which analyze them and warn about the impact on the database.

**Prerequisites:**

- A Metis account with a valid API key. [Create a project](https://www.notion.so/Create-a-project-d427d68584664fdbba4ac7b29e1dcde2?pvs=21)

**Usage:**

On code with ORMs that generates SQL files:

Link to the [action](https://github.com/marketplace/actions/analyze-migrations) in GitHub marketplace

<aside>
⚠️ Set up Postgres service that is used to produce the SQL queries. need more details also do we need it here?

</aside>

Add the following code to your GitHub Actions workflow file:

```
- name: Analyze migrations
    uses: metis-data/sql-migrations-validator@v1
    with:
      from: ${{ github.event.pull_request.base.sha }}
      to: ${{ github.event.pull_request.head.sha }}
      github_token: ${{ github.token }}
      metis_api_key: <Your Api Key>
```

**Parameters**

`from`: Base sha to be compared

`to`: Branch sha to be compared with

`github_token`: Auto generated workflow GitHub token

`metis_api_key`: Metis Api Key generated at [Metis](https://app.metisdata.io/)

**Github workflow example**

```
on:
      pull_request:
        types: [opened, reopened, edited, synchronize, ready_for_review]

    jobs:
      migrations:
        name: Analyze new migrations
        runs-on: ubuntu-latest
        steps:
          - name: Checkout
            uses: actions/checkout@v3
            with:
              fetch-depth: 0
          - name: Compare migrations
            uses: metis-data/sql-migrations-validator@v1
            with:
              from: ${{ github.event.pull_request.base.sha }}
              to: ${{ github.event.pull_request.head.sha }}
              github_token: ${{ github.token }}
              metis_api_key: <Your Api Key>
```

On JS code with Sequelize ORM:

Link to the [action](https://github.com/marketplace/actions/analyze-sequelize-migrations) in GitHub marketplace

<aside>
⚠️ Set up Postgres service that is used to produce the SQL queries. need more details

</aside>

<aside>
⚠️ Please use standard Sequelize migrations files that generated by Sequelize CLI and exports up/down functions from module.

</aside>

Add the following code to your GitHub Actions workflow file:

```
- name: Analyze migrations
    uses: metis-data/sequelize-migrations-validator@v1
    with:
      from: ${{ github.event.pull_request.base.sha }}
      to: ${{ github.event.pull_request.head.sha }}
      github_token: ${{ github.token }}
      metis_api_key: <Your Api Key>
      migrations_dir: <path/to/migrations/directory>
```

### Parameters

- `from`: Base sha to be compared
- `to`: Branch sha to be compared with
- `github_token`: Auto generated workflow GitHub token
- `metis_api_key`: Metis Api Key generated at [Metis](https://app.metisdata.io/)
- `migrations_dir`: Path in your project to Sequelize migrations directory

**Github workflow example**

```
on:
      pull_request:
        types: [opened, reopened, edited, synchronize, ready_for_review]

    jobs:
      migrations:
        name: Analyze new migrations
        runs-on: ubuntu-latest
        services:
          postgres:
            image: postgres
            env:
              POSTGRES_USER: postgres
              POSTGRES_PASSWORD: postgres
              POSTGRES_DB: postgres
            ports:
              - 5432:5432
            options: >-
              --health-cmd pg_isready
              --health-interval 10s
              --health-timeout 5s
              --health-retries 5
        steps:
          - name: Checkout
            uses: actions/checkout@v3
            with:
              fetch-depth: 0
          - name: Compare migrations
            uses: metis-data/sql-migrations-validator@v1
            with:
              from: ${{ github.event.pull_request.base.sha }}
              to: ${{ github.event.pull_request.head.sha }}
              github_token: ${{ github.token }}
              metis_api_key: <Your Api Key>
              migrations_dir: migrations
```
